
<!DOCTYPE html PUBLIC "-//IETF//DTD HTML 2.0//EN">
<HTML>
   <HEAD>
      <TITLE>
         Computer Algebra. Akhmatnurov M.F.
      </TITLE>
   <meta charset = "utf-8">
   <script src = "jquery-2.1.1.min.js"></script>
   <script src="http://d3js.org/d3.v3.min.js"></script>
   <style>

       .node circle {
           fill: #fff;
           stroke: steelblue;
           stroke-width: 3px;
       }

       .node text { font: 12px sans-serif; }

       .link {
           fill: none;
           stroke: #ccc;
           stroke-width: 2px;
       }
   </style>
   </HEAD>
<BODY>
<P>Input your expression:</P>


<input type = "text" id = "field" class = "custom" size = "100" autofocus>
<input type = "button" id = "parse_but" onclick = "Parse()" value = "Parse">
<input type = "button" id = "reset_but" onclick = "Clear()" value = "Erase">
<p id = "output" ></p>

<script>
$(document).ready(function(){
    $('#field').keypress(function(e){
        if(e.keyCode==13)
            $('#parse_but').click();
        if(e.keyCode==27)
            $('#reset_but').click();
    });
});
</script>

<script language="javascript" type="text/javascript">

 function isAlpha(c) {
    return (((c >= 'a') && (c <= 'z')) || ((c >= 'A') && (c <= 'Z')));
 }

 function isDigit(c) {
    return ((c >= '0') && (c <= '9'));
 }
 
 function isOpenBracket (c){
	return ((c == '(') || (c == '[') || (c == '{'));
 }
 
 function isCloseBracket (c){
	return ((c == ')') || (c == ']') || (c == '}'));
 }
 
 
 function isBracket (c){
	return (isOpenBracket(c) || isCloseBracket(c));
 }
 
 function isMath(c){
	return ((c == '+') || (c == '-') || (c == '*') || (c == '/') || (c == "^"))
 }
 
 
 function isCorrect (c){
	return (isAlpha(c) || isDigit(c) || isMath(c) || isBracket(c) || (c == '.'));
 }
 
function isSpace(c){
	return ((c == ' ') || (c == '\t'));
}

function deleteSpaces(expr){
	var res =[];
	for (i = 0; i < expr.length; i++){
		if (!isSpace(expr[i]))
			res.push(expr[i]);
	}
	return res;
}
 
function Parse() {
    d3.select("svg").remove();
    document.getElementById("output").innerHTML = '';
    var expr = document.getElementById("field").value;
	//expr = deleteSpaces(expr)
	//if (expr[0] =='-')
		//expr='0'+expr;
		
	var errorMessage = expr;
    var expr2 = expr;
    var correctExpr = true;
	
//  check expression
	correctExpr = ((isAlpha(expr[0])|| isDigit(expr[0])));
    var brackStack = [];
    for (i = 0; (i < expr.length) && correctExpr; i++) {
	var c;
        if (!isCorrect(expr[i])) {//check symbols
            errorMessage = "Unexpected symbol: "+expr[i];
            correctExpr = false;
            break;
        }

		//check brackets
        if (isOpenBracket(expr[i])) {
            brackNumber++;
            brackStack.push(expr[i]);
			if ((i == (expr.length - 1)) || !(isAlpha(expr[i+1]) || isDigit(expr[i+1]))){
				errorMessage = "Unexpected bracket: "+expr[i+1];
				correctExpr = false;
				break;
			}
				
        }
        if (isCloseBracket(expr[i])){
			if ((brackStack.length == 0) || !(isAlpha(expr[i-1]) || isDigit(expr[i-1]))) {
				errorMessage = "Unexpected symbol: "+expr[i];
				correctExpr = false;
				break;
			}
			c = brackStack.pop();
			switch (expr[i]){
				case ')':							
					if (c != '(') {
						errorMessage = "Unexpected bracket: "+expr[i];
						correctExpr = false;
					}				
					break;
				case ']':							
					if (c != '[') {
						errorMessage = "Unexpected bracket: "+expr[i];
						correctExpr = false;
					}				
					break;
				case '}':							
					if (c != '{') {
						errorMessage = "Unexpected bracket: "+expr[i];
						correctExpr = false;
					}				
					break;	
			}
			if (!correctExpr)
				break;
		}
    }
    if (brackStack.length > 0) {
        errorMessage = "unclosed brackets: "+brackStack.pop();
        correctExpr = false;
    }

//  check variables
    if (correctExpr == true)
        for (i = 0; i < expr.length; i++) {
            if (isAlpha(expr[i])) {
                if (i != expr.length - 1) {
                    if (isMath(expr[i + 1]))
                        expr2 = expr2.replace(expr2[i], "_");
                    else {
                        errorMessage = "unexpected symbol: "+expr[i + 1];
                        correctExpr = false;
                        break;
                    }
                }
                else
                    expr2 = expr2.replace(expr2[i], "_");
            }

            if (isAlpha(expr[i])) {
                if (i != expr.length - 1) {
                    if (isMath(expr[i + 1]) || isAlpha(expr[i+1]))
                        expr2 = expr2.replace(expr2[i], "_");
                    else {
                        errorMessage = "unexpected symbol: "+expr[i + 1];
                        correctExpr = false;
                        break;
                    }
                }
                else
                    expr2 = expr2.replace(expr2[i], "_");
            }
        }

//  check math symbols
    if (correctExpr == true)
        for (i = 0; i < expr.length; i++) {
            if (isMath(expr2[i])) 
                if ((i == 0) || (i == (expr.length - 1)) || isMath(expr2[i-1]) || isMath(expr2[i+1])) {
                    errorMessage = "unexpected symbol: "+expr[i];
                    correctExpr = false;
                    break;
                }
        }

// parse
    var arr = [];
    var var_cont = 0;
    for (i = 0; i < expr2.length; i++) {
        if (expr2[i] != '_') {
            arr.push(expr2[i]);
            var_cont = 0;
        }
        else {
            if (var_cont == 1)
                arr[arr.length - 1] = arr[arr.length - 1] + expr[i];
            else {
                arr.push(expr[i]);
                var_cont = 1;
            }
        }

    }

    var arr2 = [];
    var brackNumber = 0;
    var max_level = 0;
    for (i = 0; i < arr.length; i++) {
        if (isOpenBracket(arr[i])) {
            arr2[i] = { "name": "(", "ready": 0, "level": -1};
            brackNumber++;
            if (brackNumber > max_level)
                max_level = brackNumber;
        }
        else if (isCloseBracket(arr[i])) {
            arr2[i] = { "name": ")", "ready": 0, "level": -1};
            brackNumber--;
        }
        else if (isMath(arr[i]))
            arr2[i] = { "name": arr[i], "ready": 0, "used": 0, "level": brackNumber, "order": 0};
        else
            arr2[i] = { "name": arr[i], "ready": 1, "used": 0, "level": -1};
    }

    var order = 1;
    var power_not_found = 0, mult_not_found = 0, plus_not_found = 0;
    var oper_found;
    do {
        oper_found = 0;
        if (power_not_found == 0) {
            for (i = 0; i < arr2.length; i++) {
                if (arr2[i].level == max_level && arr2[i].order == 0)
                    if (arr2[i].name == '^') {
                        arr2[i].order = order;
                        order++;
                        oper_found = 1;
                    }
            }
            if (oper_found == 0)
                power_not_found = 1;
        }
        else if (mult_not_found == 0) {
            for (i = 0; i < arr2.length; i++) {
                if (arr2[i].level == max_level && arr2[i].order == 0)
                    if (arr2[i].name == '*' || arr2[i].name == '/') {
                        arr2[i].order = order;
                        order++;
                        oper_found = 1;
                    }
            }
            if (oper_found == 0)
                mult_not_found = 1;
        }
        else if (plus_not_found == 0) {
            for (i = 0; i < arr2.length; i++) {
                if (arr2[i].level == max_level && arr2[i].order == 0)
                    if (arr2[i].name == '+' || arr2[i].name == '-') {
                        arr2[i].order = order;
                        order++;
                        oper_found = 1;
                    }
            }
            if (oper_found == 0)
                plus_not_found = 1;
        }
        else {
            max_level--;
            power_not_found = 0;
            mult_not_found = 0;
            plus_not_found = 0;
        }
    } while (max_level > -1);

    var root_num;
    for (i = 0; i < arr2.length; i++)
        if (arr2[i].order == order - 1) {
            root_num = i;
            break;
        }


// build tree
    var parent, left, right;
    for (i = 1; i < order; i++) {
        parent = left = right = 0;
        for (p = 0; p < arr2.length; p++)                // parent
            if (arr2[p].order == i) {
                parent = p;
                for (l = p - 1; l >= 0; l--)                 // left
                    if (arr2[l].ready == 1) {
                        left = l;
                        break;
                    }
                for (r = p + 1; p < arr2.length; r++)        // right
                    if (arr2[r].ready == 1) {
                        right = r;
                        break;
                    }
                arr2[parent].children = [arr2[left], arr2[right]];
                arr2[parent].ready = 1;
                arr2[left].ready = 0;
                arr2[right].ready = 0;
                break;
            }
    }
	
	 if (!correctExpr)
        document.getElementById("output").innerHTML = errorMessage;


// ************** Generate the tree diagram *****************
    var margin = {top: 30, right: 0, bottom: 0, left: 0},
            width = 1000 - margin.right - margin.left,
            height = 600 - margin.top - margin.bottom;
    var i = 0;

    var tree = d3.layout.tree()
            .size([height, width]);

    var diagonal = d3.svg.diagonal()
            .projection(function (d) {
                return [d.x, d.y];
            });

    var svg = d3.select("body").append("svg")
            .attr("width", width + margin.right + margin.left)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    root = arr2[root_num];
    update(root);

    function update(source) {

// Compute the new tree layout.
        var nodes = tree.nodes(root).reverse(),
                links = tree.links(nodes);

// Normalize for fixed-depth.
        nodes.forEach(function (d) {
            d.y = d.depth * 100;
        });

// Declare the nodes?
        var node = svg.selectAll("g.node")
                .data(nodes, function (d) {
                    return d.id || (d.id = ++i);
                });

// Enter the nodes.
        var nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("transform", function (d) {
                    return "translate(" + d.x + "," + d.y + ")";
                });

        nodeEnter.append("circle")
                .attr("r", 10)
                .style("fill", "#fff");

        nodeEnter.append("text")
//.attr("y", function(d) {
//return d.children || d._children ? -18 : 18; })
                .attr("dy", ".35em")
                .attr("text-anchor", "middle")
                .text(function (d) {
                    return d.name;
                })
//.style("fill-opacity", 1);

// Declare the links?
        var link = svg.selectAll("path.link")
                .data(links, function (d) {
                    return d.target.id;
                });

// Enter the links.
        link.enter().insert("path", "g")
                .attr("class", "link")
                .attr("d", diagonal);

    }
    if (!correctExpr) {
        d3.select("svg").remove();
    }
}

function Clear() {
    document.getElementById("field").value = '';
    document.getElementById("output").innerHTML = '';
    text = '';
    d3.select("svg").remove();

}

</script>


</BODY>
</HTML>